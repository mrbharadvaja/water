<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Water Provision — Editable Sheet & Professional Analysis</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<!-- SheetJS for Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- jsPDF + AutoTable for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f3f6f9; }
  table td, table th { padding: 6px 8px; border: 1px solid rgba(15,23,42,0.06); }
  td input[type="text"], td input[type="number"] { width:100%; padding:6px; border:1px solid #cbd5e1; border-radius:6px; box-sizing:border-box; }
  .sticky-head th { position: sticky; top:0; background:white; z-index:2; }
  .small { font-size:0.85rem; color:#475569; }
  .muted { color:#6b7280; }
  .table-wrap { max-height:420px; overflow:auto; border-radius:8px; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
  .kpi { font-size:1.05rem; font-weight:700; color:#0f172a; }
  .chip { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:600; }
  .small-table td, .small-table th { padding:6px 8px; font-size:0.85rem; }
</style>
</head>
<body class="p-6">

<div class="max-w-7xl mx-auto">

  <header class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-slate-800">Water Provision — Editable Sheet & Professional Analysis</h1>
      <p class="small mt-1">Deep analysis tailored for TUCC Project. Edit numbers — analysis updates automatically.</p>
    </div>

    <div class="flex gap-2 items-center">

      <button id="add-row" class="px-3 py-2 bg-teal-600 text-white rounded">Add Month</button>
      <button id="reset-sample" class="px-3 py-2 bg-gray-200 rounded small">Load Sample</button>
      <button id="download-csv" class="px-3 py-2 bg-indigo-600 text-white rounded">Download CSV</button>

      <!-- NEW BUTTONS -->
      <button id="download-excel" class="px-3 py-2 bg-green-600 text-white rounded">Download Excel</button>
      <button id="download-pdf" class="px-3 py-2 bg-red-600 text-white rounded">Download PDF</button>

    </div>
  </header>

  <!-- Controls -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="p-4 bg-white rounded shadow-sm">
      <label class="small muted">Container capacity (gallons)</label>
      <input id="container-cap" type="number" value="600" class="mt-1" />
    </div>
    <div class="p-4 bg-white rounded shadow-sm">
      <label class="small muted">Litres per Gallon (used for conversion)</label>
      <input id="litres-per-gallon" type="number" value="19" class="mt-1" />
    </div>
    <div class="p-4 bg-white rounded shadow-sm">
      <label class="small muted">Default Buffer Days (per month)</label>
      <input id="default-buffer-days" type="number" value="30" class="mt-1" />
    </div>
  </div>

  <!-- Editable Sheet -->
  <div class="bg-white rounded-lg p-4 mb-6">
    <div class="flex justify-between items-center mb-3">
      <h2 class="font-semibold">Monthly Sheet</h2>
      <p class="small muted">POB / Days / Rate — edit values and review recommendations for procurement & shipping.</p>
    </div>

    <div class="table-wrap">
      <table id="sheet-table" class="min-w-full bg-white">
        <thead class="sticky-head">
          <tr>
            <th>Month</th>
            <th>POB</th>
            <th>Days</th>
            <th>Rate (L/person/day)</th>
            <th>Total Water (L)</th>
            <th>Total Water (Gallons)</th>
            <th>Buffer Days</th>
            <th>Buffer (Gallons)</th>
            <th>Containers (per buffer)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="sheet-body"></tbody>
      </table>
    </div>

    <div class="mt-3 flex gap-2">
      <button id="apply-buffer-all" class="px-3 py-2 bg-emerald-600 text-white rounded small">Apply Buffer to All</button>
      <button id="clear-table" class="px-3 py-2 bg-red-100 text-red-700 rounded small">Clear Table</button>
    </div>
  </div>

  <!-- Charts & Analysis -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

    <div class="bg-white p-4 rounded shadow-sm">
      <h3 class="font-semibold mb-3">Charts</h3>
      <canvas id="containersChart" height="220"></canvas>
      <div class="mt-4">
        <canvas id="bufferChart" height="180"></canvas>
      </div>
    </div>

    <div class="bg-white p-4 rounded shadow-sm">
      <h3 class="font-semibold mb-3">Executive Analysis & Recommendations</h3>

      <!-- Executive summary -->
      <div id="analysis" class="text-sm small muted space-y-3"></div>

      <div class="mt-4 pt-3 border-t">
        <h4 class="font-medium">Key Performance Indicators</h4>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <div class="p-3 bg-slate-50 rounded">
            <div class="small muted">Total Containers Required (sum)</div>
            <div id="total-cont-all" class="kpi">0</div>
          </div>
          <div class="p-3 bg-slate-50 rounded">
            <div class="small muted">Total Buffer (Gallons)</div>
            <div id="total-buffer-gallons" class="kpi">0</div>
          </div>
          <div class="p-3 bg-slate-50 rounded">
            <div class="small muted">Months below SOS (15 days)</div>
            <div id="months-below-sos" class="kpi">0</div>
          </div>
          <div class="p-3 bg-slate-50 rounded">
            <div class="small muted">Peak POB month</div>
            <div id="peak-month" class="kpi">-</div>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

<script>
/* ========== Editable Table + Calculation + Professional Analysis ========== */

const CONTAINER_EL = document.getElementById('container-cap');
const LITRES_EL = document.getElementById('litres-per-gallon');
const DEFAULT_BUFFER_EL = document.getElementById('default-buffer-days');

let chartContainers = null;
let chartBuffer = null;

function fmt(n){ return Number(n).toLocaleString(); }
function round1(n){ return Math.round(n*10)/10; }

/* Sample data based on your screenshot */
const sampleMonths = [
  ['Nov-25',312,15,3],
  ['Dec-25',1352,15,3],
  ['Jan-26',1759,15,3],
  ['Feb-26',1779,15,3],
  ['Mar-26',1842,15,3],
  ['Apr-26',1915,15,3],
  ['May-26',1994,15,3],
  ['Jun-26',2089,15,3],
  ['Jul-26',2104,15,3],
  ['Aug-26',2188,15,3],
  ['Sep-26',2536,15,3],
  ['Oct-26',2800,15,3],
  ['Nov-26',3473,15,3],
  ['Dec-26',3902,15,3]
];

function createRow(month='Month', pob=0, days=30, rate=3, bufferDays=null){
  const tbody = document.getElementById('sheet-body');
  if (bufferDays===null) bufferDays = Number(DEFAULT_BUFFER_EL.value);

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" class="month" value="${month}"></td>
    <td><input type="number" class="pob" value="${pob}"></td>
    <td><input type="number" class="days" value="${days}"></td>
    <td><input type="number" class="rate" value="${rate}"></td>
    <td class="litres small text-right">0</td>
    <td class="gallons small text-right">0</td>
    <td><input type="number" class="buffer-days" value="${bufferDays}"></td>
    <td class="buffer-gallons small text-right">0</td>
    <td class="containers small text-right">0</td>
    <td><button class="remove small px-2 py-1 bg-red-50 text-red-700 rounded">Del</button></td>
  `;
  tbody.appendChild(tr);

  tr.querySelectorAll("input").forEach(e => e.addEventListener("input", calculateAll));
  tr.querySelector(".remove").onclick = () => { tr.remove(); calculateAll(); };

  calculateAll();
}

function loadSample(){
  document.getElementById('sheet-body').innerHTML="";
  sampleMonths.forEach(r => createRow(r[0], r[1], r[2], r[3]));
}

function calculateAll(){
  const rows = [...document.querySelectorAll('#sheet-body tr')];

  const litresPerGallon = Number(LITRES_EL.value) || 19;
  const containerCap = Number(CONTAINER_EL.value) || 600;

  const labels = [], contData=[], bufData=[];

  // KPIs
  let totalContainers = 0, totalBufferGallons = 0, monthsBelowSOS = 0;
  const SOS_DAYS = 15;

  rows.forEach(tr=>{
    const month = tr.querySelector('.month').value;
    const pob = Number(tr.querySelector('.pob').value);
    const days = Number(tr.querySelector('.days').value);
    const rate = Number(tr.querySelector('.rate').value);
    const bufferDays = Number(tr.querySelector('.buffer-days').value);

    // Calculations
    const totalLitres = pob * days * rate;
    const totalGallons = totalLitres / litresPerGallon;

    // Buffer is calculated as (daily demand * bufferDays)
    const dailyLitres = pob * rate;
    const bufferLitres = dailyLitres * bufferDays;
    const bufferGallons = bufferLitres / litresPerGallon;

    // Containers required to hold the buffer (round up)
    const containers = Math.ceil(bufferGallons / containerCap);

    // Update row
    tr.querySelector('.litres').textContent = fmt(Math.round(totalLitres));
    tr.querySelector('.gallons').textContent = fmt(Math.round(totalGallons));
    tr.querySelector('.buffer-gallons').textContent = fmt(Math.round(bufferGallons));
    tr.querySelector('.containers').textContent = fmt(containers);

    // KPIs accumulation
    totalContainers += containers;
    totalBufferGallons += bufferGallons;
    if ((totalGallons / (dailyLitres / litresPerGallon)) < SOS_DAYS) { // if stock covers less than SOS days
      monthsBelowSOS += 1;
    }

    labels.push(month);
    contData.push(containers);
    bufData.push(Math.round(bufferGallons));
  });

  // Update KPI boxes
  document.getElementById('total-cont-all').textContent = fmt(totalContainers);
  document.getElementById('total-buffer-gallons').textContent = fmt(Math.round(totalBufferGallons));
  document.getElementById('months-below-sos').textContent = fmt(monthsBelowSOS);

  // Find peak month and max container month
  let peakPOB = -1, peakMonth='-';
  let maxCont = -1, maxContMonth='-';
  rows.forEach(tr=>{
    const pob = Number(tr.querySelector('.pob').value);
    const month = tr.querySelector('.month').value;
    const cont = Number(tr.querySelector('.containers').textContent.replace(/,/g,''));
    if (pob > peakPOB){ peakPOB = pob; peakMonth = month; }
    if (cont > maxCont){ maxCont = cont; maxContMonth = month; }
  });

  document.getElementById('peak-month').textContent = `${peakMonth} (${fmt(peakPOB)})`;

  // Charts
  renderCharts(labels, contData, bufData);

  // Professional analysis
  generateProfessionalAnalysis({
    rows,
    totalContainers,
    totalBufferGallons,
    monthsBelowSOS,
    peakMonth,
    peakPOB,
    maxCont,
    maxContMonth,
    SOS_DAYS
  });
}

function renderCharts(labels, contData, bufData){
  const c1 = document.getElementById('containersChart').getContext('2d');
  const c2 = document.getElementById('bufferChart').getContext('2d');

  if(chartContainers) chartContainers.destroy();
  if(chartBuffer) chartBuffer.destroy();

  chartContainers = new Chart(c1,{
    type:"bar",
    data:{ labels, datasets:[{ label:'Containers', data:contData, backgroundColor:"rgba(34,197,94,0.9)" }] },
    options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });

  chartBuffer = new Chart(c2,{
    type:"line",
    data:{ labels, datasets:[{ label:'Buffer (Gallons)', data:bufData, borderColor:"#0ea5e9", fill:true, tension:0.3 }] },
    options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
}

/* ========== PROFESSIONAL/CLIENT-FACING ANALYSIS ========== */
function generateProfessionalAnalysis(data){
  const { rows, totalContainers, totalBufferGallons, monthsBelowSOS, peakMonth, peakPOB, maxCont, maxContMonth, SOS_DAYS } = data;
  // Build concise, bilingual-ready (EN) executive summary
  const execTitle = `<div class="mb-1"><span class="chip">Executive Summary</span></div>`;
  let execText = `<p><strong>Summary:</strong> The current plan shows a total buffer requirement of approximately <strong>${fmt(Math.round(totalBufferGallons))} gallons</strong> across the forecast months, requiring <strong>${fmt(totalContainers)}</strong> containers (capacity: ${fmt(Number(CONTAINER_EL.value))} gal each). Peak population month is <strong>${peakMonth}</strong>. </p>`;

  // Key findings
  let findings = `<h4 class="mt-2">Key Findings</h4><ul class="list-disc pl-5 small">`;
  findings += `<li>Total buffer (all months): <strong>${fmt(Math.round(totalBufferGallons))} gallons</strong>.</li>`;
  findings += `<li>Total containers required (sum of monthly buffers): <strong>${fmt(totalContainers)}</strong>.</li>`;
  findings += `<li>Months at risk (below SOS ${SOS_DAYS} days): <strong>${fmt(monthsBelowSOS)}</strong>. These months require urgent attention to avoid stockout.</li>`;
  findings += `<li>Highest container demand: ${maxContMonth} — <strong>${fmt(maxCont)}</strong> containers.</li>`;
  findings += `</ul>`;

  // Short risk matrix (simple)
  let risk = `<h4 class="mt-2">Risk Assessment (high level)</h4>`;
  risk += `<table class="small-table" style="width:100%;border-collapse:collapse;margin-top:6px;">
    <thead><tr><th style="background:#f8fafc">Risk</th><th style="background:#f8fafc">Impact</th><th style="background:#f8fafc">Mitigation</th></tr></thead><tbody>
    <tr><td>Stockout (months below SOS)</td><td>High</td><td>Advance shipment / emergency top-up (hold separate SOS stock)</td></tr>
    <tr><td>Logistics bottleneck (many containers same month)</td><td>Medium-High</td><td>Stagger shipments; use temporary storage; increase shipping frequency</td></tr>
    <tr><td>Overstock (excess buffer)</td><td>Medium</td><td>Reduce buffer days for low-POB months; use just-in-time for predictable months</td></tr>
    </tbody></table>`;

  // Actionable recommendations (prioritized)
  let rec = `<h4 class="mt-2">Recommendations — Priority & Action Plan</h4>`;
  rec += `<ol class="pl-5 small">
    <li><strong>Immediate (0–14 days):</strong> Identify months below SOS and arrange emergency top-up shipments. Maintain a dedicated 15-day SOS reserve separate from buffer stock.</li>
    <li><strong>Near term (2–6 weeks):</strong> For months where containers ≥ 20, plan bi-weekly shipments or secure additional temporary tank storage to avoid single-point delivery stress.</li>
    <li><strong>Operational (1–3 months):</strong> Implement a rolling 60-day buffer for peak season months only; reduce to 15–30 days for off-peak to lower logistics cost.</li>
    <li><strong>Process:</strong> Cross-check POB mobilization schedules with HR/Logistics two weeks before each month to confirm assumptions and avoid over/under procurement.</li>
  </ol>`;

  // KPI snapshot
  let kpi = `<h4 class="mt-2">KPI Snapshot</h4>`;
  kpi += `<table class="small-table" style="width:100%;border-collapse:collapse;margin-top:6px;">
    <tr><td style="width:55%"><strong>Peak POB month</strong></td><td>${peakMonth} (${fmt(peakPOB)})</td></tr>
    <tr><td><strong>Highest container demand (single month)</strong></td><td>${maxContMonth} — ${fmt(maxCont)} containers</td></tr>
    <tr><td><strong>Months below SOS (${SOS_DAYS} days)</strong></td><td>${fmt(monthsBelowSOS)}</td></tr>
    <tr><td><strong>Total buffer (gallons)</strong></td><td>${fmt(Math.round(totalBufferGallons))}</td></tr>
  </table>`;

  // Recommended shipping cadence example (simple heuristic)
  let cadence = `<h4 class="mt-2">Suggested Shipping Cadence (example)</h4>`;
  cadence += `<ul class="pl-5 small">
    <li>Containers per month ≤ 8: monthly shipment</li>
    <li>Containers per month 9–20: bi-monthly (every 2 weeks)</li>
    <li>Containers per month >20: weekly shipments or temporary additional storage</li>
  </ul>`;

  // Closing note (client-ready)
  let note = `<p class="mt-2"><strong>Note:</strong> These recommendations are derived from the current forecast. Please validate final POB mobilization dates and confirm procurement lead times (recommended minimum 14 days for overseas shipments). For BP/JGC reporting, we can produce a PDF summary with header/logo and an appendix of monthly tables.</p>`;

  // Assemble final HTML
  const html = execTitle + execText + findings + risk + rec + kpi + cadence + note;
  document.getElementById('analysis').innerHTML = html;
}

/* ========== EXPORTS (CSV / XLSX / PDF) ========== */

/* Export CSV */
document.getElementById('download-csv').onclick = () => {
  let csv = "Month,POB,Days,Rate,Total(L),Gallons,BufferDays,BufferGallons,Containers\n";

  document.querySelectorAll('#sheet-body tr').forEach(tr=>{
    const c = [
      tr.querySelector('.month').value,
      tr.querySelector('.pob').value,
      tr.querySelector('.days').value,
      tr.querySelector('.rate').value,
      tr.querySelector('.litres').textContent,
      tr.querySelector('.gallons').textContent,
      tr.querySelector('.buffer-days').value,
      tr.querySelector('.buffer-gallons').textContent,
      tr.querySelector('.containers').textContent
    ];
    csv += c.join(",") + "\n";
  });

  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "Water_Provision.csv";
  a.click();
};

/* Export Excel */
document.getElementById('download-excel').onclick = () => {
  const rows = [["Month","POB","Days","Rate","Total(L)","Gallons","BufferDays","BufferGallons","Containers"]];

  document.querySelectorAll('#sheet-body tr').forEach(tr=>{
    rows.push([
      tr.querySelector('.month').value,
      tr.querySelector('.pob').value,
      tr.querySelector('.days').value,
      tr.querySelector('.rate').value,
      tr.querySelector('.litres').textContent.replace(/,/g,''),
      tr.querySelector('.gallons').textContent.replace(/,/g,''),
      tr.querySelector('.buffer-days').value,
      tr.querySelector('.buffer-gallons').textContent.replace(/,/g,''),
      tr.querySelector('.containers').textContent.replace(/,/g,'')
    ]);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "Water Provision");
  XLSX.writeFile(wb, "Water_Provision.xlsx");
};

/* Export PDF (includes executive summary + table) */
document.getElementById('download-pdf').onclick = async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"landscape"});
  // Header
  doc.setFontSize(14);
  doc.text("Water Provision — Forecast & Buffer Planning", 14, 15);
  doc.setFontSize(10);
  doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);

  // Build table data
  const data = [];
  document.querySelectorAll('#sheet-body tr').forEach(tr=>{
    data.push([
      tr.querySelector('.month').value,
      tr.querySelector('.pob').value,
      tr.querySelector('.days').value,
      tr.querySelector('.rate').value,
      tr.querySelector('.litres').textContent,
      tr.querySelector('.gallons').textContent,
      tr.querySelector('.buffer-days').value,
      tr.querySelector('.buffer-gallons').textContent,
      tr.querySelector('.containers').textContent
    ]);
  });

  // Add executive summary as text (first page)
  const execHtml = document.getElementById('analysis').innerText.split('\n').slice(0,20).join('\n'); // brief excerpt
  doc.setFontSize(10);
  doc.text(execHtml, 14, 30, { maxWidth: 270 });

  // Table with autopage
  doc.autoTable({
    startY: 80,
    head: [["Month","POB","Days","Rate","Total(L)","Gallons","BufferDays","BufferGallons","Containers"]],
    body: data,
    styles: { fontSize: 8 },
    headStyles: { fillColor: [22, 160, 133] },
    theme: 'grid'
  });

  doc.save("Water_Provision_Report.pdf");
};

/* ========== UI wiring ========== */
document.getElementById('add-row').onclick = ()=>createRow();
document.getElementById('reset-sample').onclick = ()=>loadSample();
document.getElementById('clear-table').onclick = ()=>{ document.getElementById('sheet-body').innerHTML=""; calculateAll(); };
document.getElementById('apply-buffer-all').onclick = ()=>{
  const v = Number(DEFAULT_BUFFER_EL.value) || 30;
  document.querySelectorAll('.buffer-days').forEach(i=>i.value=v);
  calculateAll();
};

loadSample();
</script>
</body>
</html>

