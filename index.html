<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Water Provision — Editable Sheet & Analysis</title>

<!-- Tailwind (cdn) -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
  body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f3f6f9; }
  table td, table th { padding: 6px 8px; border: 1px solid rgba(15,23,42,0.06); }
  td input[type="number"], td select { width:100%; box-sizing:border-box; padding:6px; border-radius:6px; border:1px solid #cbd5e1; }
  .sticky-head th { position: sticky; top:0; background:white; z-index:2; }
  .small { font-size:0.85rem; color:#475569; }
  .muted { color:#6b7280; }
  .table-wrap { max-height:420px; overflow:auto; border-radius:8px; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
</style>
</head>
<body class="p-6">

<div class="max-w-7xl mx-auto">

  <header class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-slate-800">Water Provision — Editable Sheet & Analysis</h1>
      <p class="small mt-1">Fill the Forecast POB & other fields — sheet auto-calculates totals, containers, buffer and shows charts & deep analysis.</p>
    </div>

    <div class="flex gap-2 items-center">
      <button id="add-row" class="px-3 py-2 bg-teal-600 text-white rounded">Add Month</button>
      <button id="reset-sample" class="px-3 py-2 bg-gray-200 rounded small">Load Sample</button>
      <button id="download-csv" class="px-3 py-2 bg-indigo-600 text-white rounded">Download CSV</button>
    </div>
  </header>

  <!-- Controls -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="p-4 bg-white rounded shadow-sm">
      <label class="small mut ed">Container capacity (gallons)</label>
      <input id="container-cap" type="number" value="600" min="1" class="mt-1" />
    </div>
    <div class="p-4 bg-white rounded shadow-sm">
      <label class="small muted">Gallons per 19L (conversion)</label>
      <input id="litres-per-gallon" type="number" value="19" min="1" class="mt-1" />
    </div>
    <div class="p-4 bg-white rounded shadow-sm">
      <label class="small muted">Target Buffer Days</label>
      <input id="default-buffer-days" type="number" value="30" min="0" class="mt-1" />
    </div>
  </div>

  <!-- Editable Table -->
  <div class="bg-white rounded-lg p-4 mb-6 container-card">
    <div class="flex justify-between items-center mb-3">
      <h2 class="font-semibold">Monthly Sheet</h2>
      <p class="small muted">Edit Forecast POB / Days / Rate → others auto-calc</p>
    </div>

    <div class="table-wrap">
      <table id="sheet-table" class="min-w-full bg-white">
        <thead class="sticky-head">
          <tr>
            <th>Month</th>
            <th>Forecast POB at Site</th>
            <th>Days in Month</th>
            <th>Rate (L/person/day)</th>
            <th>Total Drinking Water (L)</th>
            <th>Total Drinking Water (in Gallon 19 L)</th>
            <th>Total Buffer Stock for <span id="buffer-visible">30</span> Days (L)</th>
            <th>Total Buffer Stock (in Gallon 19 L)</th>
            <th>Shipping in Container (600 Gallon per Container)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="sheet-body">
          <!-- Rows are inserted by JS -->
        </tbody>
        <tfoot>
          <tr class="bg-slate-50">
            <td class="small font-medium">Totals / Summary</td>
            <td id="sum-pob" class="small text-right pr-3">0</td>
            <td id="sum-days" class="small text-right pr-3">0</td>
            <td></td>
            <td id="sum-litres" class="small text-right pr-3">0</td>
            <td id="sum-gallons" class="small text-right pr-3">0</td>
            <td id="sum-buffer-litres" class="small text-right pr-3">0</td>
            <td id="sum-buffer-gallons" class="small text-right pr-3">0</td>
            <td id="sum-containers" class="small text-right pr-3">0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="mt-3 flex gap-2">
      <button id="apply-buffer-all" class="px-3 py-2 bg-emerald-600 text-white rounded small">Apply default buffer to all</button>
      <button id="clear-table" class="px-3 py-2 bg-red-100 text-red-700 rounded small">Clear table</button>
    </div>
  </div>

  <!-- Charts & Deep Analysis -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

    <div class="bg-white p-4 rounded shadow-sm">
      <h3 class="font-semibold mb-3">Charts</h3>
      <canvas id="containersChart" height="220"></canvas>
      <div class="mt-4">
        <canvas id="bufferChart" height="180"></canvas>
      </div>
    </div>

    <div class="bg-white p-4 rounded shadow-sm">
      <h3 class="font-semibold mb-3">Deep Analysis & Recommendations</h3>
      <div id="analysis" class="text-sm space-y-2 small muted">
        <!-- Analysis injected here -->
      </div>

      <div class="mt-4 pt-3 border-t">
        <h4 class="font-medium">Quick KPI</h4>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <div class="p-3 bg-slate-50 rounded">
            <div class="small muted">Peak Month (POB)</div>
            <div id="peak-month" class="font-semibold">-</div>
          </div>
          <div class="p-3 bg-slate-50 rounded">
            <div class="small muted">Month with Max Containers</div>
            <div id="max-cont-month" class="font-semibold">-</div>
          </div>
          <div class="p-3 bg-slate-50 rounded">
            <div class="small muted">Total Containers (All months)</div>
            <div id="total-cont-all" class="font-semibold">0</div>
          </div>
          <div class="p-3 bg-slate-50 rounded">
            <div class="small muted">Total Buffer (Gallons)</div>
            <div id="total-buffer-gallons" class="font-semibold">0</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <footer class="text-xs text-gray-500 small">
    Tip: You can edit any numeric cell. Use "Load Sample" to populate the table with your screenshot-like months.
  </footer>

</div>

<script>
/* ===============================
   Editable sheet + calculations
   =============================== */

const CONTAINER_EL = document.getElementById('container-cap');
const LITRES_PER_GALLON_EL = document.getElementById('litres-per-gallon');
const DEFAULT_BUFFER_EL = document.getElementById('default-buffer-days');
const BUFFER_VISIBLE = document.getElementById('buffer-visible');

let chartContainers = null;
let chartBuffer = null;

BUFFER_VISIBLE.textContent = DEFAULT_BUFFER_EL.value;

// helper formatting
function fmt(n) { return (isNaN(n) ? 0 : Math.round(n)).toLocaleString(); }
function fdec(n){ return (isNaN(n) ? 0 : Number(n.toFixed(1))).toLocaleString(); }

const sampleMonths = [
  ['Nov-25',312,15,3],
  ['Dec-25',1352,15,3],
  ['Jan-26',1759,15,3],
  ['Feb-26',1779,15,3],
  ['Mar-26',1842,15,3],
  ['Apr-26',1915,15,3],
  ['May-26',1994,15,3],
  ['Jun-26',2089,15,3],
  ['Jul-26',2104,15,3],
  ['Aug-26',2188,15,3],
  ['Sep-26',2536,15,3],
  ['Oct-26',2800,15,3],
  ['Nov-26',3473,15,3],
  ['Dec-26',3902,15,3]
];

function createRow(month='Month', pob=0, days=30, rate=3, bufferDays=null) {
  const tbody = document.getElementById('sheet-body');
  const tr = document.createElement('tr');

  // If no bufferDays provided, get default
  if (bufferDays===null) bufferDays = Number(DEFAULT_BUFFER_EL.value);

  tr.innerHTML = `
    <td><input class="month" value="${month}" /></td>
    <td><input class="pob" type="number" min="0" value="${pob}" /></td>
    <td><input class="days" type="number" min="0" value="${days}" /></td>
    <td><input class="rate" type="number" min="0" step="0.1" value="${rate}" /></td>
    <td class="litres small text-right">0</td>
    <td class="gallons small text-right">0</td>
    <td><input class="buffer-days" type="number" min="0" value="${bufferDays}" /></td>
    <td class="buffer-gallons small text-right">0</td>
    <td class="containers small text-right">0</td>
    <td class="text-center">
      <button class="remove small px-2 py-1 bg-red-50 text-red-700 rounded">Del</button>
    </td>
  `;
  tbody.appendChild(tr);

  // attach listeners
  tr.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input', calculateAll);
  });
  tr.querySelector('.remove').addEventListener('click', ()=>{ tr.remove(); calculateAll(); });

  calculateAll();
}

function clearTable(){
  document.getElementById('sheet-body').innerHTML = '';
  calculateAll();
}

function loadSample(){
  clearTable();
  for (const row of sampleMonths) createRow(row[0], row[1], row[2], row[3]);
  calculateAll();
}

document.getElementById('add-row').addEventListener('click', ()=>createRow());
document.getElementById('clear-table').addEventListener('click', clearTable);
document.getElementById('reset-sample').addEventListener('click', loadSample);
document.getElementById('container-cap').addEventListener('input', calculateAll);
document.getElementById('litres-per-gallon').addEventListener('input', calculateAll);
document.getElementById('default-buffer-days').addEventListener('input', ()=>{
  BUFFER_VISIBLE.textContent = DEFAULT_BUFFER_EL.value;
});
document.getElementById('apply-buffer-all').addEventListener('click', ()=>{
  const v = Number(DEFAULT_BUFFER_EL.value);
  document.querySelectorAll('.buffer-days').forEach(inp=>inp.value = v);
  calculateAll();
});

/* Main calc */
function calculateAll(){
  const rows = Array.from(document.querySelectorAll('#sheet-body tr'));
  const litresPerGallon = Number(LITRES_PER_GALLON_EL.value) || 19;
  const containerCapacity = Number(CONTAINER_EL.value) || 600;

  let sumPob = 0, sumDays = 0, sumLitres = 0, sumGallons = 0, sumBufferLitres = 0, sumBufferGallons = 0, sumContainers = 0;
  const labels = [], containersData = [], bufferData = [];

  rows.forEach(tr=>{
    const month = tr.querySelector('.month').value || '-';
    const pob = Number(tr.querySelector('.pob').value) || 0;
    const days = Number(tr.querySelector('.days').value) || 0;
    const rate = Number(tr.querySelector('.rate').value) || 0;
    const bufferDays = Number(tr.querySelector('.buffer-days').value) || Number(DEFAULT_BUFFER_EL.value);

    const totalLitres = pob * days * rate;
    const totalGallons = totalLitres / litresPerGallon;
    const bufferLitres = (pob * rate) * bufferDays; // bufferDays * dailyAvgLitres (per month population)
    const bufferGallons = bufferLitres / litresPerGallon;
    const containersNeeded = Math.ceil(bufferGallons / containerCapacity);

    tr.querySelector('.litres').textContent = fmt(totalLitres);
    tr.querySelector('.gallons').textContent = fmt(totalGallons);
    tr.querySelector('.buffer-gallons').textContent = fmt(bufferGallons);
    tr.querySelector('.containers').textContent = fmt(containersNeeded);

    sumPob += pob;
    sumDays += days;
    sumLitres += totalLitres;
    sumGallons += totalGallons;
    sumBufferLitres += bufferLitres;
    sumBufferGallons += bufferGallons;
    sumContainers += containersNeeded;

    labels.push(month);
    containersData.push(containersNeeded);
    bufferData.push(Math.round(bufferGallons));
  });

  // update totals row
  document.getElementById('sum-pob').textContent = fmt(sumPob);
  document.getElementById('sum-days').textContent = fmt(sumDays);
  document.getElementById('sum-litres').textContent = fmt(sumLitres);
  document.getElementById('sum-gallons').textContent = fmt(sumGallons);
  document.getElementById('sum-buffer-litres').textContent = fmt(sumBufferLitres);
  document.getElementById('sum-buffer-gallons').textContent = fmt(sumBufferGallons);
  document.getElementById('sum-containers').textContent = fmt(sumContainers);

  // Charts
  renderCharts(labels, containersData, bufferData);

  // Deep analysis
  generateAnalysis(rows, { sumPob, sumLitres, sumBufferGallons, sumContainers });
}

/* Charts rendering */
function renderCharts(labels, containersData, bufferData){
  const ctx1 = document.getElementById('containersChart').getContext('2d');
  const ctx2 = document.getElementById('bufferChart').getContext('2d');

  if (chartContainers) chartContainers.destroy();
  if (chartBuffer) chartBuffer.destroy();

  chartContainers = new Chart(ctx1, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Containers needed (per month)', data: containersData, backgroundColor: 'rgba(34,197,94,0.8)' }] },
    options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });

  chartBuffer = new Chart(ctx2, {
    type: 'line',
    data: { labels, datasets: [{ label: 'Buffer (Gallons)', data: bufferData, fill:true, tension:0.2 }] },
    options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
}

/* Deep analysis & recommendations */
function generateAnalysis(rows, sums){
  const analysis = document.getElementById('analysis');
  const totalContainers = sums.sumContainers;
  const totalBufferGallons = Math.round(sums.sumBufferGallons);
  // find peak month and max containers month
  let peakPob = -1, peakMonth = '-';
  let maxContainers = -1, maxContMonth = '-';

  rows.forEach(tr=>{
    const month = tr.querySelector('.month').value || '-';
    const pob = Number(tr.querySelector('.pob').value) || 0;
    const cont = Number(tr.querySelector('.containers').textContent.replace(/,/g,'')) || 0;
    if (pob > peakPob){ peakPob = pob; peakMonth = month; }
    if (cont > maxContainers){ maxContainers = cont; maxContMonth = month; }
  });

  // Create textual analysis
  let html = '';
  html += `<p><strong>Total forecast POB:</strong> ${fmt(sums.sumPob)} persons across all months.</p>`;
  html += `<p><strong>Total drinking water demand (L):</strong> ${fmt(Math.round(sums.sumLitres))} L — which is approx <strong>${fmt(Math.round(sums.sumGallons))}</strong> gallons.</p>`;
  html += `<p><strong>Total buffer requirement:</strong> ~${fmt(totalBufferGallons)} gallons across months (based on per-row buffer days), needing roughly <strong>${fmt(totalContainers)}</strong> containers of ${CONTAINER_EL.value} gallons each.</p>`;

  // Risk & timing insights
  html += `<p><strong>Peak POB month:</strong> ${peakMonth} (${fmt(peakPob)} persons).</p>`;
  html += `<p><strong>Maximum containers required in a single month:</strong> ${maxContMonth} (${fmt(maxContainers)} containers).</p>`;

  // Actionable recommendations
  html += `<h4 class="mt-2">Recommendations</h4>`;
  html += `<ul class="list-disc pl-5 small muted">
    <li>Keep SOS/minimum stock for emergency (15 days) separate from buffer — ensure at least 15 days of supply held onsite.</li>
    <li>Plan shipping cadence around months where <strong>containers needed ≥ 20</strong> — consider bi-weekly shipments or temporary extra storage.</li>
    <li>Review months where daily rate or POB spikes: validate POB accuracy (mobilization/demobilization) to avoid overstocking.</li>
    <li>Optimize buffer days: for months with low POB, reduce buffer days to save logistics cost; for peak seasons increase buffer to avoid stockouts.</li>
  </ul>`;

  // Short table of high-risk months
  const highRisk = rows.filter(tr => {
    const cont = Number(tr.querySelector('.containers').textContent.replace(/,/g,'')) || 0;
    return cont >= Math.max(10, Math.ceil(totalContainers / Math.max(1, rows.length))); // heuristic
  }).map(tr=>`${tr.querySelector('.month').value} (${tr.querySelector('.containers').textContent} containers)`);

  if (highRisk.length) {
    html += `<p><strong>High logistics pressure months:</strong> ${highRisk.join(', ')}</p>`;
  }

  analysis.innerHTML = html;

  // KPI box updates
  document.getElementById('peak-month').textContent = peakMonth;
  document.getElementById('max-cont-month').textContent = maxContMonth;
  document.getElementById('total-cont-all').textContent = fmt(totalContainers);
  document.getElementById('total-buffer-gallons').textContent = fmt(totalBufferGallons);
}

/* CSV download */
document.getElementById('download-csv').addEventListener('click', ()=>{
  const rows = Array.from(document.querySelectorAll('#sheet-body tr'));
  const lines = [];
  const header = ['Month','Forecast POB','Days in Month','Rate (L/person/day)','Total Drinking Water (L)','Total Drinking Water (Galls)','Buffer Days','Buffer (Galls)','Containers'];
  lines.push(header.join(','));
  rows.forEach(tr=>{
    const month = tr.querySelector('.month').value.replace(/,/g,'');
    const pob = tr.querySelector('.pob').value;
    const days = tr.querySelector('.days').value;
    const rate = tr.querySelector('.rate').value;
    const litres = tr.querySelector('.litres').textContent.replace(/,/g,'');
    const galls = tr.querySelector('.gallons').textContent.replace(/,/g,'');
    const bufferDays = tr.querySelector('.buffer-days').value;
    const bufferGallons = tr.querySelector('.buffer-gallons').textContent.replace(/,/g,'');
    const containers = tr.querySelector('.containers').textContent.replace(/,/g,'');

    lines.push([month,pob,days,rate,litres,galls,bufferDays,bufferGallons,containers].join(','));
  });

  const csv = lines.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'water_provision_sheet.csv'; a.click(); URL.revokeObjectURL(url);
});

/* Initialize */
loadSample();
</script>

</body>
</html>
